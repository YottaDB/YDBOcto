
-- TC055 : OCTO583 : Validate IDENTIY constraint on columns
-- INSERT
-- GENERATED ALWAYS AS IDENTITY
DROP TABLE IF EXISTS test;
CREATE TABLE test (id INT GENERATED ALWAYS AS IDENTITY, str TEXT);
  INSERT INTO test VALUES('first'); -- ERROR: type missmatch integer and varchar in Postgres but IDENTITY error in Octo because of order in which error is checked
  INSERT INTO test VALUES(3,'second'); -- ERROR cannot insert into GENERATED ALWAYS type of column (hint: use OVERRIDE with INSERT)
  INSERT INTO test(id,str) VALUES(3,'second'); -- ERROR cannot insert into GENERATED ALWAYS type of column (hint: use OVERRIDE with INSERT)
  INSERT INTO test(id,str) SELECT 1,'third' UNION SELECT 2,'fourth'; -- ERROR cannot insert into GENERATED ALWAYS type of column (hint: use OVERRIDE with INSERT)
  INSERT INTO test SELECT 1,'third' UNION SELECT 2,'fourth'; -- ERROR cannot insert into GENERATED ALWAYS type of column (hint: use OVERRIDE with INSERT)
  SELECT * FROM test;
  -- OVERRIDING SYSTEM VALUE
  DROP TABLE IF EXISTS test;
  CREATE TABLE test (id INT GENERATED ALWAYS AS IDENTITY, str TEXT);
  INSERT INTO test VALUES(99,'fifth'); -- EROR cannot insert into GENERATED ALWAYS type of column (hint: use OVERRIDE with INSERT)
  SELECT * FROM test;
DROP TABLE IF EXISTS test;

-- GENERATED BY DEFAULT
CREATE TABLE test (id INT GENERATED BY DEFAULT AS IDENTITY, str TEXT);
  INSERT INTO test VALUES('first'); -- ERROR ERR_INSERT_TYPE_MISMATCH
DROP TABLE IF EXISTS test;

-- UPDATE
-- GENERATED ALWAYS AS IDENTITY
CREATE TABLE test (id INT GENERATED ALWAYS AS IDENTITY, str TEXT);
  UPDATE test SET id=1; -- ERROR column "id" can only be updated to DEFAULT (ERR_UPDATE_OF_GENERATED_ALWAYS_IDENTITY)
  UPDATE test SET id=1,str='first'; -- ERROR column "id" can only be updated to DEFAULT (ERR_UPDATE_OF_GENERATED_ALWAYS_IDENTITY)
  UPDATE test SET id=1; -- ERROR column "id" can only be updated to DEFAULT (ERR_UPDATE_OF_GENERATED_ALWAYS_IDENTITY)
DROP TABLE IF EXISTS test;

-- PRIMARY KEY
CREATE TABLE test (id INT PRIMARY KEY GENERATED ALWAYS AS IDENTITY, str TEXT);
  INSERT INTO test VALUES(1,'second'); -- IDENTITY column error (ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY)
  INSERT INTO test OVERRIDING SYSTEM VALUE VALUES(1,'second'); -- ERR_DUPLICATE_KEY_VALUE error
DROP TABLE IF EXISTS test;

-- IDENTITY on ready-only table
CREATE TABLE test (id INT GENERATED ALWAYS AS IDENTITY, str TEXT) READONLY; -- ERR_READONLY_DISALLOWED error

-- Implicit read-only table with IDENTITY
CREATE TABLE namesE(id INTEGER PRIMARY KEY GENERATED ALWAYS AS IDENTITY,firstName VARCHAR EXTRACT "^names(keys(""id""))",lastName VARCHAR) GLOBAL "^names(keys(""id""))"; -- ERR_READONLY_AND_READWRITE_DISALLOWED

-- Copying data from a table when destination table has identity columns
CREATE TABLE test (id INT GENERATED ALWAYS AS IDENTITY, str TEXT);
INSERT INTO test SELECT id, lastname FROM names; -- IDENTITY column error (ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY)
INSERT INTO test OVERRIDING SYSTEM VALUE VALUES(NULL,'first'); -- ERR_NULL_COL_VALUE for id
INSERT INTO test SELECT id, lastname FROM names; -- ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY
SELECT * FROM test;
INSERT INTO test VALUES(NULL,'first'); -- ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY
SELECT * FROM test;
DROP TABLE IF EXISTS test;

-- IDENTITY on non-integer columns (ERR_NON_INTEGER_IDENTITY error is expected)
CREATE TABLE test (name TEXT GENERATED ALWAYS AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name VARCHAR(20) GENERATED ALWAYS AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name NUMERIC GENERATED ALWAYS AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name NUMERIC(20,2) GENERATED ALWAYS AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name BOOLEAN GENERATED ALWAYS AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint

CREATE TABLE test (name TEXT GENERATED BY DEFAULT AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name VARCHAR(20) GENERATED BY DEFAULT AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name NUMERIC GENERATED BY DEFAULT AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name NUMERIC(20,2) GENERATED BY DEFAULT AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint
CREATE TABLE test (name BOOLEAN GENERATED BY DEFAULT AS IDENTITY, id INT); -- Error IDENTITY column can only be on smallint, integer or bigint

-- OVERRIDING USER VALUE working with GENERATED ALWAYS AS IDENTITY (Error ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY)
create table test (id int generated always as identity, name text);
insert into test(id,name) overriding user value values(5,'first'); -- ERROR Cannot insert, column `id` defined as GENERATED ALWAYS IDENTITY
insert into test overriding user value values(5,'second'); -- ERROR Cannot insert, column `id` defined as GENERATED ALWAYS IDENTITY
DROP TABLE IF EXISTS test;

-- DEFAULT set value for non-IDENTITY column in an UPDATE query is not implemented. Such usage should result in
-- ERR_FEATURE_NOT_IMPLEMENTED error.
-- Note:
-- * test_createtable.bats.in includes READONLY as table type in octo.conf. This results in the table `test` being considered as a READONLY
--   table. In this case, `UPDATE` that follows will lead to a `ERR_TABLE_READONLY` error and thats not what we are testing. Hence the use of
--   READWRITE keyword to allow `UPDATE` usage on the table.
create table test (id int, name text) READWRITE;
update test set id=default;
DROP TABLE IF EXISTS test;

-- Test that ERR_TABLE_MULTIPLE_IDENTITY message is seen when mutiple identity keywords are included for a column
create table test (id int generated always as identity generated by default as identity, name text);
create table test (id int generated always as identity generated by default as identity generated by default as identity, name text);
create table test (id int generated by default as identity generated by default as identity generated by default as identity, name text);
create table test (name text, id int generated always as identity generated by default as identity);
DROP TABLE
CREATE TABLE
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
LINE 6:2:   INSERT INTO test(id,str) VALUES(3,'second'); -- ERROR cannot i...
                             ^^
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
LINE 7:2:   INSERT INTO test(id,str) SELECT 1,'third' UNION SELECT 2,'four...
                             ^^
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
ID|STR
(0 rows)
DROP TABLE
CREATE TABLE
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
ID|STR
(0 rows)
DROP TABLE
CREATE TABLE
[ERROR]: ERR_INSERT_TYPE_MISMATCH: Column 'ID' is of type INTEGER but expression is of type VARCHAR
DROP TABLE
CREATE TABLE
[ERROR]: ERR_UPDATE_OF_GENERATED_ALWAYS_IDENTITY: Updating a GENERATED ALWAYS IDENTITY column 'TEST.ID' to a non-DEFAULT value is invalid.
LINE 22:1: UPDATE test SET id=1; -- ERROR column "id" can only be updated t...
                             ^^
[ERROR]: ERR_UPDATE_OF_GENERATED_ALWAYS_IDENTITY: Updating a GENERATED ALWAYS IDENTITY column 'TEST.ID' to a non-DEFAULT value is invalid.
LINE 23:2:   UPDATE test SET id=1,str='first'; -- ERROR column "id" can onl...
                             ^^
[ERROR]: ERR_UPDATE_OF_GENERATED_ALWAYS_IDENTITY: Updating a GENERATED ALWAYS IDENTITY column 'TEST.ID' to a non-DEFAULT value is invalid.
LINE 24:2:   UPDATE test SET id=1; -- ERROR column "id" can only be updated...
                             ^^
DROP TABLE
CREATE TABLE
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
INSERT 0 1
DROP TABLE
[ERROR]: ERR_READONLY_DISALLOWED: READONLY keyword in CREATE TABLE is disallowed due to an incompatible keyword
[ERROR]: ERR_READONLY_AND_READWRITE_DISALLOWED: CREATE TABLE specifies keywords that make it incompatible with both READONLY and READWRITE keywords
CREATE TABLE
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
[ERROR]: ERR_NULL_COL_VALUE: NULL value in column ID violates NOT NULL constraint
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
ID|STR
(0 rows)
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
ID|STR
(0 rows)
DROP TABLE
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 45:1: CREATE TABLE test (name TEXT GENERATED ALWAYS AS IDENTITY, id IN...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 46:2: CREATE TABLE test (name VARCHAR(20) GENERATED ALWAYS AS IDENTITY...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 47:2: CREATE TABLE test (name NUMERIC GENERATED ALWAYS AS IDENTITY, id...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 48:2: CREATE TABLE test (name NUMERIC(20,2) GENERATED ALWAYS AS IDENTI...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 49:2: CREATE TABLE test (name BOOLEAN GENERATED ALWAYS AS IDENTITY, id...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 51:3: CREATE TABLE test (name TEXT GENERATED BY DEFAULT AS IDENTITY, i...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 52:2: CREATE TABLE test (name VARCHAR(20) GENERATED BY DEFAULT AS IDEN...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 53:2: CREATE TABLE test (name NUMERIC GENERATED BY DEFAULT AS IDENTITY...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 54:2: CREATE TABLE test (name NUMERIC(20,2) GENERATED BY DEFAULT AS ID...
                              ^^^^
[ERROR]: ERR_NON_INTEGER_IDENTITY: Only integer columns can be an identity column
LINE 55:2: CREATE TABLE test (name BOOLEAN GENERATED BY DEFAULT AS IDENTITY...
                              ^^^^
CREATE TABLE
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
LINE 58:1: insert into test(id,name) overriding user value values(5,'first'...
                            ^^
[ERROR]: ERR_INSERT_ON_GENERATED_ALWAYS_IDENTITY: Cannot INSERT into GENERATED ALWAYS identity column 'TEST.ID'. Use OVERRIDING SYSTEM VALUE to override.
DROP TABLE
CREATE TABLE
[ERROR]: ERR_FEATURE_NOT_IMPLEMENTED: Feature not implemented: DEFAULT value for a column is only allowed for IDENTITY columns
LINE 63:1: update test set id=default;
                           ^^
DROP TABLE
[ERROR]: ERR_TABLE_MULTIPLE_IDENTITY: Multiple identity specified for column 'ID' of table 'TEST'
LINE 66:1: ...always as identity generated by default as identity, name text);
                                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[ERROR]: ERR_TABLE_MULTIPLE_IDENTITY: Multiple identity specified for column 'ID' of table 'TEST'
LINE 67:1: ...ays as identity generated by default as identity generated by de...
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[ERROR]: ERR_TABLE_MULTIPLE_IDENTITY: Multiple identity specified for column 'ID' of table 'TEST'
LINE 68:1: ...ult as identity generated by default as identity generated by de...
                              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
[ERROR]: ERR_TABLE_MULTIPLE_IDENTITY: Multiple identity specified for column 'ID' of table 'TEST'
LINE 69:1: ... generated always as identity generated by default as identity);
                                            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
