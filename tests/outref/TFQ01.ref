
-- TFQ01 : Test various queries generated by fuzz testing

-------------------------------------------------------------------------------
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1388510181
-------------------------------------------------------------------------------
-- This used to previously SIG-11.
-- Expected output is an ERR_SELECT_STAR_NO_TABLES error.
select (select *) between 1 and 2;

-------------------------------------------------------------------------------
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1388513250
-------------------------------------------------------------------------------
-- This used to previously assert fail as follows.
-- 	src/populate_data_type.c:1165: populate_data_type: Assertion '(select_STATEMENT != table_alias->table->type) || (table_alias->table->v.select->select_list == table_alias->column_list)' failed.
-- Expected output for below query is `1` (aka `t` for TRUE).
select (select 1) between 1 and 2;
select (select 1 is null) between false and true;

-------------------------------------------------------------------------------
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1492162026
-------------------------------------------------------------------------------

-- This used to previously SIG-11.
-- Expected output is a "syntax error".
create table tmp (firstname varchar, fullname1 varchar extract concat(firstname,));

-- This used to previously Assert fail at get_key_columns.c:47
-- Expected output is an ERR_TOO_MANY_TABLE_KEYCOLS error
create table tmp (id integer key num 1000);

-- Test HUGE positive number that in turn is treated as a negative number when atoi() is done.
-- Expected output is an ERR_TOO_MANY_TABLE_KEYCOLS error
create table tmp (id1 integer key num 48901234567890 key num 1);

-- This used to previously SIG-11 in generate_physical_plan.c
-- Expected output is an ERR_TOO_MANY_SELECT_KEYCOLS error
create table c ( id0 INTEGER, id1 INTEGER, id2 INTEGER, id3 INTEGER, id4 INTEGER, id5 INTEGER, id6 INTEGER, id7 INTEGER, name VARCHAR(20), PRIMARY KEY (id0, id1, id2, id3, id4, id5, id6, id7));
select 1 from  c c1, c c2, c c3, c c4, c c5, c c6, c c7, c c8, c c9, c c10, c c11, c c12, c c13, c c14, c c15, c c16, c c17, c c18, c c19, c c20, c c21, c c22, c c23, c c24, c c25, c c26, c c27, c c28, c c29, c c30, c c31, c c32, c c33;
drop table c;

-- This used to previously SIG-11 in parse_literal_to_parameter.c:33
-- Expected output is no error in the "create table" or when inserting 'abc%' but
-- an ERR_CHECK_CONSTRAINT_VIOLATION error when inserting 'abcd'.
create table tmp (lastname varchar, check((lastname like 'abc\%')));
insert into tmp values ('abc%');
insert into tmp values ('abcd');
drop table tmp;

-----------------------------------------------------------------------------------------
-- Test of binary operations evaluating to NULL in IN operand list along with TABLENAME.ASTERISK
-- Test of (4) in https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1492162026
-- This used to previously SIG-11 in "validate_table_asterisk_binary_operation()"
-- Expected output is no error in any of the below queries.
-- Note: These queries are not run through crosscheck as Postgres issues an operator not unique error.
-----------------------------------------------------------------------------------------
select n1.* in (NULL % NULL , n1.*) from names n1;

-- Test of similar queries like above.
select n1.* in (NULL, n1.*) from names n1;
select n1.* in (NULL - NULL , n1.*) from names n1;
select n1.* in (NULL + NULL , n1.*) from names n1;
select n1.* in (NULL * NULL , n1.*) from names n1;

-------------------------------------------------------------------------------
-- Test CASE inside a subquery used as a binary operand in outer query
-- This used to previously SIG-11 in lp_is_operand_type_string.c.
-- Expected output is no error.
-------------------------------------------------------------------------------
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1495138200
select (case when id > (select 1) then (select 1) else (select 0) end)=1 as idbool from names;

-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1495376878
select (case when true then 1 end) = 1;

-- Test "Issue 1" in https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040 issue description
select 1 group by 92729326636806986;

-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040#note_1890253295
select 1 group by 17777000000000010101;
\d;

-- Test "Issue 2" in https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040 issue description
create table tmp (id integer primary key, dob date EXTRACT "$GET(^datetimedateys(""il"")))") global "^date(keys(""id"")))"   global "^datetimedate";
drop table tmp;
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040#note_1894418515
create table tmp (id integer) global "^date(1)" global "^date2";
drop table tmp;

-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040#note_1897959123
select 1 where (select 't');
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040#note_1898075506
delete from names where (select 't');
-- Test https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/1040#note_1898221014
update names set firstname = 'abcd' where (select 't');
select 1 from names group by firstname having (select 't');
select 1 from names inner join names n2 on (select 't');

[ERROR]: ERR_SELECT_STAR_NO_TABLES: SELECT * with no tables specified is not valid
LINE 5:3: select (select *) between 1 and 2;
                         ^
OCTO> -------------------------------------------------------------------------------
-------------------------------------------------------------------------------
select (select *) between 1 and 2;
OCTO> -------------------------------------------------------------------------------
-------------------------------------------------------------------------------
select (select 1) between 1 and 2;
???
t
(1 row)
OCTO> select (select 1 is null) between false and true;
???
t
(1 row)
[ERROR]: ERR_PARSE_FAILED: syntax error, unexpected RIGHT_PAREN
LINE 15:4: ...rstname varchar, fullname1 varchar extract concat(firstname,));
                                                                          ^
OCTO> -------------------------------------------------------------------------------
-------------------------------------------------------------------------------

create table tmp (firstname varchar, fullname1 varchar extract concat(firstname,));
[ERROR]: ERR_TOO_MANY_TABLE_KEYCOLS: Too many key columns specified in CREATE TABLE of tmp (got: 1000, max: 255)
OCTO> create table tmp (id integer key num 1000);
[ERROR]: ERR_TOO_MANY_TABLE_KEYCOLS: Too many key columns specified in CREATE TABLE of tmp (got: 48901234567890, max: 255)
OCTO> create table tmp (id1 integer key num 48901234567890 key num 1);
OCTO> create table c ( id0 INTEGER, id1 INTEGER, id2 INTEGER, id3 INTEGER, id4 INTEGER, id5 INTEGER, id6 INTEGER, id7 INTEGER, name VARCHAR(20), PRIMARY KEY (id0, id1, id2, id3, id4, id5, id6, id7));
CREATE TABLE
OCTO> select 1 from  c c1, c c2, c c3, c c4, c c5, c c6, c c7, c c8, c c9, c c10, c c11, c c12, c c13, c c14, c c15, c c16, c c17, c c18, c c19, c c20, c c21, c c22, c c23, c c24, c c25, c c26, c c27, c c28, c c29, c c30, c c31, c c32, c c33;
[ERROR]: ERR_TOO_MANY_SELECT_KEYCOLS: Too many key columns specified in SELECT query (got: 264, max: 256)
[ERROR]: ERR_PLAN_NOT_GENERATED: Failed to generate physical plan
OCTO> drop table c;
DROP TABLE
OCTO> create table tmp (lastname varchar, check((lastname like 'abc\%')));
CREATE TABLE
OCTO> insert into tmp values ('abc%');
INSERT 0 1
OCTO> insert into tmp values ('abcd');
[ERROR]: ERR_CHECK_CONSTRAINT_VIOLATION: New row for table tmp violates CHECK constraint tmp_lastname_check : Failing row contains (abcd)
OCTO> drop table tmp;
DROP TABLE
OCTO> -----------------------------------------------------------------------------------------
-----------------------------------------------------------------------------------------
select n1.* in (NULL % NULL , n1.*) from names n1;
???
t
t
t
t
t
t
(6 rows)
OCTO> select n1.* in (NULL, n1.*) from names n1;
???
t
t
t
t
t
t
(6 rows)
OCTO> select n1.* in (NULL - NULL , n1.*) from names n1;
???
t
t
t
t
t
t
(6 rows)
OCTO> select n1.* in (NULL + NULL , n1.*) from names n1;
???
t
t
t
t
t
t
(6 rows)
OCTO> select n1.* in (NULL * NULL , n1.*) from names n1;
???
t
t
t
t
t
t
(6 rows)
OCTO> -------------------------------------------------------------------------------
-------------------------------------------------------------------------------
select (case when id > (select 1) then (select 1) else (select 0) end)=1 as idbool from names;
idbool
f
f
t
t
t
t
(6 rows)
OCTO> select (case when true then 1 end) = 1;
???
t
(1 row)
[ERROR]: ERR_GROUP_BY_POSITION_INVALID: GROUP BY position 92729326636806986 is not in select list
LINE 45:1: select 1 group by 92729326636806986;
                             ^^^^^^^^^^^^^^^^^
OCTO> select 1 group by 92729326636806986;
[ERROR]: ERR_GROUP_BY_POSITION_NOT_INTEGER: Non integer constant 17777000000000010101 in GROUP BY
LINE 47:1: select 1 group by 17777000000000010101;
                             ^^^^^^^^^^^^^^^^^^^^
OCTO> select 1 group by 17777000000000010101;
OCTO> \d;
Schema|Name|Type|Owner
public|information_schema.tables|table|octo
public|names|table|octo
public|nameswithages|table|octo
public|octoonerowtable|table|octo
public|pg_aggregate|table|octo
public|pg_am|table|octo
public|pg_attrdef|table|octo
public|pg_attribute|table|octo
public|pg_catalog.pg_aggregate|table|octo
public|pg_catalog.pg_am|table|octo
public|pg_catalog.pg_attrdef|table|octo
public|pg_catalog.pg_attribute|table|octo
public|pg_catalog.pg_class|table|octo
public|pg_catalog.pg_constraint|table|octo
public|pg_catalog.pg_conversion|table|octo
public|pg_catalog.pg_database|table|octo
public|pg_catalog.pg_depend|table|octo
public|pg_catalog.pg_description|table|octo
public|pg_catalog.pg_enum|table|octo
public|pg_catalog.pg_index|table|octo
public|pg_catalog.pg_inherits|table|octo
public|pg_catalog.pg_language|table|octo
public|pg_catalog.pg_namespace|table|octo
public|pg_catalog.pg_policies|table|octo
public|pg_catalog.pg_proc|table|octo
public|pg_catalog.pg_range|table|octo
public|pg_catalog.pg_rewrite|table|octo
public|pg_catalog.pg_roles|table|octo
public|pg_catalog.pg_settings|table|octo
public|pg_catalog.pg_shdescription|table|octo
public|pg_catalog.pg_tablespace|table|octo
public|pg_catalog.pg_trigger|table|octo
public|pg_catalog.pg_type|table|octo
public|pg_catalog.pg_user|table|octo
public|pg_class|table|octo
public|pg_constraint|table|octo
public|pg_conversion|table|octo
public|pg_database|table|octo
public|pg_depend|table|octo
public|pg_description|table|octo
public|pg_enum|table|octo
public|pg_index|table|octo
public|pg_inherits|table|octo
public|pg_language|table|octo
public|pg_namespace|table|octo
public|pg_policies|table|octo
public|pg_proc|table|octo
public|pg_range|table|octo
public|pg_rewrite|table|octo
public|pg_roles|table|octo
public|pg_settings|table|octo
public|pg_shdescription|table|octo
public|pg_tablespace|table|octo
public|pg_trigger|table|octo
public|pg_type|table|octo
public|pg_user|table|octo
(56 rows)
OCTO> create table tmp (id integer primary key, dob date EXTRACT "$GET(^datetimedateys(""il"")))") global "^date(keys(""id"")))"   global "^datetimedate";
CREATE TABLE
OCTO> drop table tmp;
DROP TABLE
OCTO> create table tmp (id integer) global "^date(1)" global "^date2";
CREATE TABLE
OCTO> drop table tmp;
DROP TABLE
[ERROR]: ERR_TYPE_NOT_COMPATIBLE: Type VARCHAR not compatible for boolean operations
LINE 55:1: select 1 where (select 't');
                          ^^^^^^^^^^^^
OCTO> select 1 where (select 't');
[ERROR]: ERR_TYPE_NOT_COMPATIBLE: Type VARCHAR not compatible for boolean operations
LINE 56:1: delete from names where (select 't');
                                   ^^^^^^^^^^^^
OCTO> delete from names where (select 't');
[ERROR]: ERR_TYPE_NOT_COMPATIBLE: Type VARCHAR not compatible for boolean operations
LINE 57:1: update names set firstname = 'abcd' where (select 't');
                                                     ^^^^^^^^^^^^
OCTO> update names set firstname = 'abcd' where (select 't');
[ERROR]: ERR_TYPE_NOT_COMPATIBLE: Type VARCHAR not compatible for boolean operations
LINE 58:1: select 1 from names group by firstname having (select 't');
                                                         ^^^^^^^^^^^^
OCTO> select 1 from names group by firstname having (select 't');
[ERROR]: ERR_TYPE_NOT_COMPATIBLE: Type VARCHAR not compatible for boolean operations
LINE 59:1: select 1 from names inner join names n2 on (select 't');
                                                      ^^^^^^^^^^^^
OCTO> select 1 from names inner join names n2 on (select 't');
OCTO> 

-------------------------------------------------------------------------------
-- Test of https://gitlab.com/YottaDB/DBMS/YDBOcto/-/issues/803#note_1494165192
-------------------------------------------------------------------------------

-- This used to previously SIG-11.
-- Expected output is an ERR_TOO_MANY_KEYCOLS error
DROP TABLE
[ERROR]: ERR_TOO_MANY_TABLE_KEYCOLS: Too many key columns specified in CREATE TABLE of tmp (got: 256, max: 255)

