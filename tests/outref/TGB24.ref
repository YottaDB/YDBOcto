
-- helper function
DROP FUNCTION IF EXISTS XECUTE_M_CODE(VARCHAR);
CREATE FUNCTION XECUTE_M_CODE(VARCHAR) RETURNS INTEGER AS $$XecuteMCode^Q6F;

-- creating a function for cutting "year" from datelabel
DROP FUNCTION IF EXISTS ZEXT(VARCHAR,INTEGER,INTEGER);
CREATE FUNCTION ZEXT(VARCHAR,INTEGER,INTEGER) RETURNS VARCHAR AS $$ZEXT^Q6F;
--this is a shortened table to show the error
DROP TABLE IF EXISTS QAUDITCEVENT;
CREATE TABLE QAUDITCEVENT
(
ID VARCHAR PRIMARY KEY,
DATELABEL VARCHAR,
EVENTNAME VARCHAR
) GLOBAL "^qAuditC";

SELECT XECUTE_M_CODE("kill ^qAuditC");
SELECT XECUTE_M_CODE("set ^qAuditC(1)=""20200101|New Year"",^qAuditC(2)=""20200229|Leap Day""");
SELECT XECUTE_M_CODE("set ^qAuditC(3)=""20210101|New Year""");

-- making an sql expression with grouping by year:
SELECT ZEXT(DATELABEL, 1, 4), count (*) from QAUDITCEVENT group by ZEXT(DATELABEL, 1,4);
SELECT ZEXT(DATELABEL, 1, 4), count (*) from QAUDITCEVENT group by 1;
DROP FUNCTION
CREATE FUNCTION
DROP FUNCTION
CREATE FUNCTION
DROP TABLE
CREATE TABLE
XECUTE_M_CODE
0
(1 row)
XECUTE_M_CODE
0
(1 row)
XECUTE_M_CODE
0
(1 row)
ZEXT|COUNT(*)
2020|2
2021|1
(2 rows)
ZEXT|COUNT(*)
2020|2
2021|1
(2 rows)
